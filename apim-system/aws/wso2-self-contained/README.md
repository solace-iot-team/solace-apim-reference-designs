# WSO2 Self-Contained Setup

 WORK IN PROGRESS

Scripts to install and deploy an Async-API management platform self-contained setup in AWS.

- 1 AWS VPC
- 1 Public IP-Address assigned to each EC2 instance
- BOX 1 -  AWS EC2 (1 EC2 instance)
  - Docker Host with   
    - MongoDB
    - Async-API Platform API
    - Async-API Web Portal 
- BOX 2 -  AWS EC2 (1 EC2 instance)
  - WSO2 Identity Server
- BOX 3 -  AWS EC2 (1 EC2 instance)
  - WSO2 API Manager



## Setup and Bootstrap

### Preconditions

Linux based deployment host (tested on Mac OS) 
- Terraform must be installed  ( get it from [HashiCorp](https://www.terraform.io/))
- Ansible must be installed  (get it from the Project [Ansible](https://github.com/ansible) )
- AWS CLI and AWS Credentials should be installed (see [Terraform Prerequisites](https://learn.hashicorp.com/tutorials/terraform/aws-build))
  

### Adjust Defaults

Invoke script `prepare_automation_configuration.sh` once:
- `sensitive_ansible_vars.yml` will get created based on `template_sensitive_ansible_vars.yml`
- `sensitive_org_vars.yml` will get created based on `template_sensitive_org_vars.yml`
- `terraform.tfvars.json` will get created based on `template_terraform.tfvars.json`

#### AWS Defaults
Adjust AWS infrastructure defaults in `vars/terraform.tfvars.json`

| Point of variation | default | purpose |
|-------------------|----------|---------|
| aws_region | eu-central-1 | AWS regsion
| ssh_key_filename | `../shared/keys/aws_key_box.pub`|points to aws-key for EC2. Get generated by Ansible during bootstrapping or can get provided up-front |
| ssh_key_name | `my_key_name`| ssh_key in ssh_key_file will get uploaded to AWS key-manager and referenced as `ssh_key_name` |
| ami_box_1 | `ami-0e0102e3ff768559b`|  AWS-AMI name, depending on aws_region. Must be Ubuntu 18.04 LTS based |
| ami_box_2 | `ami-0e0102e3ff768559b`|  AWS-AMI name, depending on aws_region. Must be Ubuntu 18.04 LTS based |
| ami_box_3 | `ami-0e0102e3ff768559b`|  AWS-AMI name, depending on aws_region. Must be Ubuntu 18.04 LTS based |
| instance_type_box_1 |`t2.small` | AWS instance type |
| instance_type_box_2 |`t2.small` | AWS instance type |
| instance_type_box_3 |`t2.small` | AWS instance type |
| ebs_volume_box_1_size | `10`| Size in GB of mounted EBS volume of EC2 Box1 instance. MongoDB will store its data on this volume |  
| ebs_volume_box_2_size | `10`| Size in GB of mounted EBS volume of EC2 Box2 instance.|  
| ebs_volume_box_3_size | `10`| Size in GB of mounted EBS volume of EC2 Box3 instance.|  
| allowed_inbound_cidr_blocks | `["0.0.0.0.0/0"]` | List of CIDR blocks allowed to access Portal and Platform-API |
| allowed_inbound_ssh_cidr_blocks | `["0.0.0.0.0/0"]` | List of CIDR blocks allowed to access setup via SSH |
| allowed_inbound_administration_cidr_blocks | `["0.0.0.0.0/0"]` | List of CIDR blocks allowed to access MySQL |
| name_prefix | `async-api-wso2-selfcontained` | Prefix for AWS resources names (EC2, ....)  |
| tag_name_prefix | `async-api-wso2-selfcontained` | Prefix for TAGS of AWS resources  |
| tag_owner | `theOwner` | TAG `owner` of AWS resources  |
| tag_project | `async-api-wso2-selfcontained` | TAG `project` of AWS resources  |


#### Ansible Defaults

Adjust Ansible defaults in `vars/sensitive_ansible_vars.yml` 

:warning: It is strongly advised to change all default usernames and passwords 
| Point of variation | default | purpose |
|--------------------|---------|---------|
| platform-api version | latest | Version TAG of Platform-API |
| portal_version | `latest` | Version TAG of Platform-API Portal Docker Container |
| sammode | `prod`| enable / disable authentication of Platform-API-Portal |
| solace_spa_users | list of users | Plaform-API usernames to access Platform-API |
| solace_spa_user | `admin1` | the platform-api user for e.g. portal (one entry of `solace_spa_users`)|
| solace_spa_password | `secret1` | Plaform-API secret1 |
| solace_spa_adminuser | `admin2` | Admin of Platform-API username| 
| solace_spa_adminpassword | `secret2` | Password of Admin Platform-API user| 
|solace_portal_login_user | `portal`| Username to access web portal |
|solace_portal_login_password | `secret3` | Password to access web portal   
|mysql_user | `user1` | Pre-deployed MySql user
|mysql_password | `password1` | Password ofo pre-deployed MySql user
|mysql_root_password | `password2` | Root-Password of MySql

### Bootstrap

Bootstrapping can get triggered by calling `create_infrastructure.sh`. 

After successfully bootstrapping EC2 instance IP and DNS-name can get found in `generated/boxes.json`

- Async-API Web Portal can get accessed at `http://<ec2-server-name | ec2-server-ip>`
- Async-API Platform API Swagger / OpenAPI specification can get accesses at: `http://http:<ec2-server-name | ec2-server-ip>:3000`

### Deploy Organization and Environments

An `Organization` with `Environments` and `Developers` can get populated by

- adjusting `sensitive_org_vars.yml`
- invoking `register_org.yml`


### Destroy 

The entire infrastructure can get removed by calling `destroy_infrastructure.sh`

### Change existing infrastructure

After bootstrapping the AWS infrastructure can get adjusted by tailoring terraform scripts and configuration files in `terraform/` and invoking `terraform apply` in folder `terraform/`. 

Ansible can get utilized to adjust and tailor the deployment and configuration of Platform-API and Platform-API Web Portal by adjusting Ansible files and invoking an Ansible playbook accordingly.

---


